# Система авторизации DnD GenLab Assistant

## Обзор

В приложение добавлена система авторизации, которая требует входа в систему для доступа ко всем функциям.

## Учетные данные по умолчанию

### Администратор
- **Логин**: `admin`
- **Пароль**: `admpass123`
- **Тариф**: Studio (1,000,000 токенов)

### Демо-пользователь
- **Логин**: `demo`
- **Пароль**: `demo`
- **Тариф**: Pro (500,000 токенов)

## Функции

### Страница входа
- Доступна по адресу `/login`
- Простая форма с полями логин/пароль
- Валидация на стороне клиента и сервера
- Отображение ошибок авторизации

### Защита маршрутов
- Все маршруты (кроме `/login`) защищены middleware
- Неавторизованные пользователи автоматически перенаправляются на `/login`
- Публичные маршруты: `/login`, `/api/auth/login`

### Навигация
- Отображает имя текущего пользователя
- Кнопка "Выход" для завершения сеанса
- Скрывается на странице входа

### API Endpoints

#### POST /api/auth/login
Вход в систему
```json
{
  "username": "admin",
  "password": "admpass123"
}
```

Ответ:
```json
{
  "success": true,
  "user": {
    "id": "...",
    "username": "admin",
    "name": "Администратор",
    "email": "admin@dndgenlab.com"
  }
}
```

#### POST /api/auth/logout
Выход из системы

#### GET /api/auth/me
Проверка текущего пользователя

## Безопасность

### Хеширование паролей
- Пароли хешируются с помощью SHA-256
- Хеши хранятся в базе данных
- Пароли в открытом виде никогда не сохраняются

### Управление сеансами
- Используются HTTP-only cookies для хранения токенов
- Токены генерируются на основе временной метки и случайного значения
- Автоматическое истечение через 7 дней
- Secure flag включен в production режиме

### Middleware
- Проверяет наличие userId в cookies
- Перенаправляет неавторизованных пользователей
- Не применяется к статическим файлам

## Установка

Если вы обновляете существующую базу данных, выполните:

```bash
# Windows
setup-auth.bat

# Linux/Mac
chmod +x setup-auth.sh
./setup-auth.sh
```

Или вручную:
```bash
npx prisma db push --force-reset --accept-data-loss
npx prisma generate
npm run db:seed
```

⚠️ **ВНИМАНИЕ**: Команда `--force-reset` удалит все существующие данные!

## Структура базы данных

Модель `User` обновлена:
```prisma
model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String   // Хэш пароля
  email     String?  @unique
  name      String   @default("Мастер")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  projects     Project[]
  creditBudget CreditBudget?
  requestLogs  RequestLog[]
}
```

## Следующие шаги

### Возможные улучшения:
1. **Регистрация новых пользователей** - форма регистрации
2. **Восстановление пароля** - функция сброса пароля
3. **Управление профилем** - изменение пароля и данных
4. **Роли пользователей** - администратор, пользователь, гость
5. **OAuth провайдеры** - вход через Google, Discord и т.д.
6. **Двухфакторная аутентификация** - дополнительная безопасность
7. **История входов** - отслеживание сеансов
8. **Токены обновления** - для длительных сеансов

## Файлы

### Новые файлы:
- `src/lib/auth.ts` - утилиты для работы с паролями
- `src/app/api/auth/login/route.ts` - API входа
- `src/app/api/auth/logout/route.ts` - API выхода
- `src/app/api/auth/me/route.ts` - API проверки пользователя
- `src/app/login/page.tsx` - страница входа
- `src/middleware.ts` - middleware для защиты маршрутов
- `setup-auth.bat` / `setup-auth.sh` - скрипты установки

### Измененные файлы:
- `prisma/schema.prisma` - добавлены поля username и password
- `prisma/seed.ts` - создание пользователей по умолчанию
- `src/components/Navigation.tsx` - отображение статуса входа

## Поддержка

Если возникли проблемы:
1. Убедитесь, что база данных была пересоздана
2. Проверьте, что seed выполнен успешно
3. Очистите cookies браузера
4. Перезапустите сервер разработки

