# Исправление ошибки Foreign Key после добавления авторизации

## Проблема

После добавления системы авторизации и пересоздания базы данных возникала ошибка при попытке создать новый проект:

```
Invalid `prisma.project.create()` invocation:
Foreign key constraint violated: `foreign key`
```

## Причина

Все API endpoints использовали старый способ получения userId:
```typescript
const userId = process.env.DEMO_USER_ID || 'demo-user-001';
```

Этот пользователь с таким ID больше не существовал в новой базе данных после пересоздания.

## Решение

### 1. Создана утилита для получения userId из cookies

Файл: `src/lib/auth.ts`
```typescript
export function getUserIdFromRequest(request: NextRequest): string {
  const userId = request.cookies.get('userId')?.value;
  
  if (!userId) {
    throw new Error('Пользователь не авторизован');
  }
  
  return userId;
}
```

### 2. Обновлены все API endpoints

Обновлены следующие файлы для использования userId из cookies:

#### Основные API:
- ✅ `src/app/api/projects/route.ts` - GET и POST методы
- ✅ `src/app/api/profile/route.ts` - GET метод
- ✅ `src/app/api/payment/mock/route.ts` - POST метод

#### Generate API:
- ✅ `src/app/api/generate/campaign-base/route.ts`
- ✅ `src/app/api/generate/campaign-scenes/route.ts`
- ✅ `src/app/api/generate/scene-npcs/route.ts`
- ✅ `src/app/api/generate/scene-encounter/route.ts`
- ✅ `src/app/api/generate/session/route.ts`
- ✅ `src/app/api/generate/scene/route.ts`
- ✅ `src/app/api/generate/npc/route.ts`
- ✅ `src/app/api/generate/encounter/route.ts`

### 3. Обработка ошибок

В catch блоках всех generate endpoints добавлена проверка:
```typescript
export async function POST(request: NextRequest) {
  let userId = '';
  
  try {
    userId = getUserIdFromRequest(request);
    // ... остальной код
  } catch (error: any) {
    console.error('Error:', error);
    
    // Логируем ошибку только если userId был получен
    if (userId) {
      await logRequest(userId, 'type', {...}, 'unknown', false, error.message);
    }
    
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}
```

## Изменения в коде

### До:
```typescript
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const userId = process.env.DEMO_USER_ID || 'demo-user-001';
    // ...
  } catch (error: any) {
    const userId = process.env.DEMO_USER_ID || 'demo-user-001';
    await logRequest(userId, ...);
  }
}
```

### После:
```typescript
export async function POST(request: NextRequest) {
  let userId = '';
  
  try {
    userId = getUserIdFromRequest(request);
    const body = await request.json();
    // ...
  } catch (error: any) {
    if (userId) {
      await logRequest(userId, ...);
    }
  }
}
```

## Результат

✅ Все API endpoints теперь корректно работают с системой авторизации
✅ userId получается из cookie, установленного при входе
✅ Проекты создаются для текущего авторизованного пользователя
✅ Все операции привязаны к правильному пользователю

## Проверка

После исправления:
1. ✅ Войдите в систему (admin/admpass123)
2. ✅ Создайте новую кампанию вручную
3. ✅ Сгенерируйте кампанию через AI
4. ✅ Все операции должны работать без ошибок Foreign Key

## Дата исправления

14 октября 2025 года

